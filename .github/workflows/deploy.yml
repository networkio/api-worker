name: Deploy Worker

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Debug - whoami & kv list (use npx to guarantee wrangler v4)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "== wrangler whoami =="
          npx --yes wrangler@4 whoami || true
          echo "== wrangler kv:namespace list =="
          npx --yes wrangler@4 kv:namespace list || true

      - name: Validate required KV namespaces exist
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          STOCK_KV_ID: ${{ secrets.STOCK_KV_ID }}
          API_KEYS_KV_ID: ${{ secrets.API_KEYS_KV_ID }}
          RATE_LIMIT_KV_ID: ${{ secrets.RATE_LIMIT_KV_ID }}
          METRICS_KV_ID: ${{ secrets.METRICS_KV_ID }}
        run: |
          set -euo pipefail
          echo "Listing KV namespaces..."
          npx --yes wrangler@4 kv:namespace list > kvs.txt || true
          cat kvs.txt
          MISSING=0

          check_id() {
            local name="$1"
            local id="$2"
            if [ -z "$id" ]; then
              echo "Skipping check for $name (no secret provided)."
              return
            fi
            if grep -q "$id" kvs.txt; then
              echo "Found $name with id $id"
            else
              echo "::error::$name with id $id not found in this account"
              MISSING=1
            fi
          }

          check_id "STOCK_KV" "$STOCK_KV_ID"
          check_id "API_KEYS_KV" "$API_KEYS_KV_ID"
          check_id "RATE_LIMIT_KV" "$RATE_LIMIT_KV_ID"
          check_id "METRICS_KV" "$METRICS_KV_ID"

          if [ "$MISSING" -eq 1 ]; then
            echo "One or more required KV namespaces are missing. Fix the bindings or secrets and re-run."
            exit 1
          fi

          echo "All requested KV namespaces exist (or were skipped)."

      - name: Deploy Worker (Cloudflare Wrangler Action)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # Use name to avoid passing empty --env; deploy to top-level config
          command: deploy --name stockai-2api
        env:
          API_MASTER_KEY: ${{ secrets.API_MASTER_KEY }}
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
          API_KEYS: ${{ secrets.API_KEYS }}
