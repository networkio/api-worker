name: Deploy Worker

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install jq (used to parse lists)
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Debug - whoami & kv list (use wrangler v4 via npx)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "== wrangler@4 whoami =="
          npx --yes wrangler@4 whoami || true
          echo "== wrangler@4 kv:namespace list =="
          # List namespaces and print JSON; v4 supports --json for namespace list
          npx --yes wrangler@4 kv:namespace list --json || npx --yes wrangler@4 kv:namespace list || true

      - name: Validate KV ids (optional, will skip if secrets not provided)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          STOCK_KV_ID: ${{ secrets.STOCK_KV_ID }}
          API_KEYS_KV_ID: ${{ secrets.API_KEYS_KV_ID }}
          RATE_LIMIT_KV_ID: ${{ secrets.RATE_LIMIT_KV_ID }}
          METRICS_KV_ID: ${{ secrets.METRICS_KV_ID }}
        run: |
          set -euo pipefail
          echo "Checking provided KV ids against account visibility..."
          ns_json="$(npx --yes wrangler@4 kv:namespace list --json 2>/dev/null || echo '[]')"
          echo "$ns_json" | jq -r '.[] | "\(.id) \(.title)"' > namespaces.txt || true
          cat namespaces.txt || true
          check() {
            local name="$1"; local id="$2"
            if [ -z "$id" ]; then
              echo "Skipping $name (no secret supplied)"
              return
            fi
            if grep -q "$id" namespaces.txt; then
              echo "Found $name ($id)"
            else
              echo "::error::$name with id $id not found in account (check CLOUDFLARE_API_TOKEN / account)"
              exit 1
            fi
          }
          check "STOCK_KV" "$STOCK_KV_ID" || true
          check "API_KEYS_KV" "$API_KEYS_KV_ID" || true
          check "RATE_LIMIT_KV" "$RATE_LIMIT_KV_ID" || true
          check "METRICS_KV" "$METRICS_KV_ID" || true
          echo "KV validation done."

      - name: Deploy with wrangler v4 via npx
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          API_MASTER_KEY: ${{ secrets.API_MASTER_KEY }}
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
          # keep other runtime vars as needed
        run: |
          set -euo pipefail
          echo "Deploying with npx wrangler@4 (explicitly using v4 to avoid version mismatch)..."
          # ensure the runner uses the intended config (project root)
          npx --yes wrangler@4 deploy --name stockai-2api --account-id "${CLOUDFLARE_ACCOUNT_ID}"
