name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler@4.53.0

      - name: Verify Authentication
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: wrangler whoami

      - name: Deploy Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          echo "开始部署到 Cloudflare Workers..."
          
          # 使用 wrangler deploy 命令，不指定环境参数
          wrangler deploy --minify
          
          echo "部署完成！"
          echo "Worker 地址：https://stockai-2api.<your-username>.workers.dev"
          
      # 可选：部署后设置环境变量
      - name: Set Secrets (Optional)
        if: success() && env.API_MASTER_KEY != ''
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          API_MASTER_KEY: ${{ secrets.API_MASTER_KEY }}
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS || '*' }}
          API_KEYS: ${{ secrets.API_KEYS || '' }}
        run: |
          echo "设置环境变量..."
          if [ -n "$API_MASTER_KEY" ]; then
            echo "设置 API_MASTER_KEY..."
            echo "$API_MASTER_KEY" | wrangler secret put API_MASTER_KEY
          fi
          
          if [ -n "$ALLOWED_ORIGINS" ]; then
            echo "设置 ALLOWED_ORIGINS..."
            echo "$ALLOWED_ORIGINS" | wrangler secret put ALLOWED_ORIGINS
          fi
          
          if [ -n "$API_KEYS" ]; then
            echo "设置 API_KEYS..."
            echo "$API_KEYS" | wrangler secret put API_KEYS
          fi
